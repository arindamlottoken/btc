<!DOCTYPE HTML>

<html>

<head>
<!-- Required meta tags -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <script src="https://rawgit.com/ethereum/web3.js/0.16.0/dist/web3.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>
    <script src="https://rawgit.com/ethereum/web3.js/0.16.0/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethjs@0.3.0/dist/ethjs.min.js"></script>
    <script src="bitcore-lib.js"></script>
    <script src="bitcore-explorers.min.js"></script>
    <script src="bitcoinjs-min.js"></script>
    <script src="sjcl.js"></script>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">

  <title>Numisafe Protection for your Crypto Assets</title>

</head>
<body>

    <div class="container">
        <div class="jumbotron" style="background-image: url(https://blog.oup.com/wp-content/uploads/2015/12/Snow-field-1260px.jpg);">
        <h1 class="display-5" align="center" >Protect with Numisafe Platform</h1>
        <h2 align="center" id="securingheader" style="display:none" >..Securing Now..</h2>
        <h2 align="center" id="securedheader" style="display:none" >..All Secured..</h2>
        <h2 align="center" id="recoveringheader" style="display:none" >..Recovering Now..</h2>
        <h2 align="center" id="recoveredheader" style="display:none" >..All Recovered..</h2>
        </div>
    </div>

    <div class="container" align="center">

    <div class="row">
    <div class="form-group col">
    <label for="phone" class="col-form-label col-form-label-lg">Phone Number</label>
    <input type="phone" class="form-control  form-control-lg" id="phone" aria-describedby="phoneHelp" placeholder="Enter phone">
    </div>
    <div class="form-group col">
    <label for="email" class="col-form-label col-form-label-lg">Email Address</label>
    <input type="email" class="form-control  form-control-lg" id="email" aria-describedby="emailHelp" placeholder="Enter email">
    </div>
    </div> <!-- phone and email input block -->
    
    <div class="row" id="btckeyblock" style="display:none" >
    <div class="form-group col">
    <label for="btckey" class="col-form-label col-form-label-lg">Bitcoin Private Key</label>
    <input type="password" class="form-control  form-control-lg" id="btckey" aria-describedby="passwordHelp" placeholder="Enter Bitcoin Private Key">
    </div>
    </div> <!-- BTC Key Block -->

    <div class="container" align="center">
    <button class="btn btn-primary btn-lg" id="secure">Secure My Bitcoin</button>
    <button class="btn btn-primary btn-lg" id="securenext" style="display:none">Start Securing My Bitcoin</button>
    <button class="btn btn-primary btn-lg" id="recover">Locate My Recovery Account</button>
    </div> <!-- main buttons block -->

    </div>  <!-- main  block -->

    <div class="container" align="center" id="recoveracctsection" style="display:none">
    <div class="container" align="center">
    <button class="btn btn-primary btn-lg" id="beginrecover" style="display:none">Begin Recovery Process</button>
    <button class="btn btn-primary btn-lg" id="transfereth" style="display:none">Transfer Assets</button>
    </div>  <!-- recovery buttons  -->
    <div class="container" align="center">
    <div id="recoverystarted" style="display:none"><b><br>Recovery process started...⌛<br></b></div>
    <div id="recoverydone" style="display:none"><b><br>Assets ready to be transferred to recovery account.<br></b></div>
    <div id="assettransferstarted" style="display:none"><b><br>Assets transfer started...⌛<br></b></div>
    <div id="assettransferdone" style="display:none"><b><br>Assets transfer done and everything recovered.<br></b></div>
    </div>  <!-- strings for different steps block -->
    </div>  <!-- recoveracctsection block -->


    <div class="container" id="sendingethertocontract" style="display:none"><b>Sending your ethereum in protective custody of Numisafe...⌛</b></div>
    
    <div class="container" id="secureacctsection" align="center" style="display:none">

    <div class="container" id="keygen" align="center" style="display:none">

    <b>Generating your recovery keys......</b>
    </div> <!-- keygen block  -->
   

    <div id="questionblock" align="center" style="display:none">
    <div align="center" class="container pre-scrollable">
    <b> Answer atleast 7 questions. </b>
    <br>
    If not relevant, leave answers to the following questions empty.
    <br>
    <br>
    1. What is the first name of your spouse's father?<input id="q1">
    <br>
    2. What was your High School Mascot?  <input id="q2">
    <br>
    3. In what city or town did you meet your spouse/partner?  <input id="q3">
    <br>
    4. In what city or town did your mother and father meet?  <input id="q4">
    <br>
    5. In what town or city was your first full time job?  <input id="q5">
    <br>
    6. What is the make of your first car?  <input id="q6">
    <br>
    7. What is the name of your first pet?  <input id="q7">
    <br>
    8. What is the name of your first school? <input id="q8">
    <br>
    9. What is your oldest child's nickname? <input id="q9">
    <br>
    10. What is the name of the place your wedding reception was held? <input id="q10">
    <br>
    11. What is the name of your favorite childhood friend? <input id="q11">
    <br>
    12. What school did you attend for sixth grade? <input id="q12">
    <br>
    13. What time of the day was your first child born? (hh:mm) <input id="q13">
    <br>
    14. What time of the day were you born? (hh:mm) <input id="q14">
    <br>
    15. What was the house number and street name you lived in as a child? <input id="q15">
    <br>
    16. What was the last name of your third grade teacher? <input id="q16">
    <br>
    17. What was the make and model of your first car? <input id="q17">
    <br>
    18. What was the name of the company where you had your first job? <input id="q18">
    <br>
    19. What was the name of the hospital where you were born? <input id="q19">
    <br>
    20. What was the name of your elementary / primary school? <input id="q20">
    <br>
    21. What was the name of your first stuffed animal or doll or action figure? <input id="q21">
    <br>
    22. What was your childhood nickname? <input id="q22">
    <br>
    23. What was your favorite food as a child? <input id="q23">
    <br>
    24. What was your favorite place to visit as a child? <input id="q24">
    <br>
    25. What was your favorite sport in high school? <input id="q25">
    <br>
    26. What were the last four digits of your childhood telephone number? <input id="q26">
    <br>
    27. Where were you New Year's 2000? <input id="q27">
    <br>
    28. Who is your childhood sports hero? <input id="q28">
    <br>
    29. Who was your childhood hero? <input id="q29">
    <br>
    30. What is your youngest child's nickname? <input id="q30">
    <br>
    <br>
    </div>   <!-- scrolling container -->

    <div class="container" align="center">
    <button class="btn btn-primary btn-lg" id="encrypt">Done Answering</button>
    </div> <!-- encrypt button -->
    </div> <!-- question block -->
    
    <div class="container">
    <button class="btn btn-primary btn-lg" id="start" align="center" style="display:none">Internet Turned Off (Generate My Recovery Keys)</button>
    </div> <!-- internet off container  -->

    </div>  <!-- secureacctsection block -->

<script>

// Bitcore variables 
var bitcore = require("bitcore-lib")
bitcore.Networks.defaultNetwork = bitcore.Networks.testnet;
var explo = require("bitcore-explorers")
var insight = new explo.Insight()
var outsight = new explo.Insight()

// Global key variables FOR RECOVERY ACCOUNT
var multiSigAddress;
var multiSigAddressStr = "";
// if veto is activated, need 2 signatures
var requiredSignatures = 1  // required signatures for multisig account
var vetoPublicKeyStr = "0339C61A4974EFCC8D7FC0262FAD4D31B167276977C2EFB1374EEA3C829206F237"
var vetoPublicKey;
var privateKey;
var keyAddress;
var encryptedBlurb = "";
var email = "";
var phone = "";
var originalAddress = ""; // original wallet address which was secured
var btckey = ""; // original wallet address private key 
var originalKey; // original key private key structure
var originalPublicKey;
var recoveryPrivateKey;
var recoveryPublicKey;

function startEncrypt() {
    var q1 = document.getElementById('q1').value.trim().toLowerCase();
    var q2 = document.getElementById('q2').value.trim().toLowerCase();
    var q3 = document.getElementById('q3').value.trim().toLowerCase();
    var q4 = document.getElementById('q4').value.trim().toLowerCase();
    var q5 = document.getElementById('q5').value.trim().toLowerCase();
    var q6 = document.getElementById('q6').value.trim().toLowerCase();
    var q7 = document.getElementById('q7').value.trim().toLowerCase();
    var q8 = document.getElementById('q8').value.trim().toLowerCase();
    var q9 = document.getElementById('q9').value.trim().toLowerCase();
    var q10 = document.getElementById('q10').value.trim().toLowerCase();
    var q11 = document.getElementById('q11').value.trim().toLowerCase();
    var q12 = document.getElementById('q12').value.trim().toLowerCase();
    var q13 = document.getElementById('q13').value.trim().toLowerCase();
    var q14 = document.getElementById('q14').value.trim().toLowerCase();
    var q15 = document.getElementById('q15').value.trim().toLowerCase();
    var q16 = document.getElementById('q16').value.trim().toLowerCase();
    var q17 = document.getElementById('q17').value.trim().toLowerCase();
    var q18 = document.getElementById('q18').value.trim().toLowerCase();
    var q19 = document.getElementById('q19').value.trim().toLowerCase();
    var q20 = document.getElementById('q20').value.trim().toLowerCase();
    var q21 = document.getElementById('q21').value.trim().toLowerCase();
    var q22 = document.getElementById('q22').value.trim().toLowerCase();
    var q23 = document.getElementById('q23').value.trim().toLowerCase();
    var q24 = document.getElementById('q24').value.trim().toLowerCase();
    var q25 = document.getElementById('q25').value.trim().toLowerCase();
    var q26 = document.getElementById('q26').value.trim().toLowerCase();
    var q27 = document.getElementById('q27').value.trim().toLowerCase();
    var q28 = document.getElementById('q28').value.trim().toLowerCase();
    var q29 = document.getElementById('q29').value.trim().toLowerCase();
    var q30 = document.getElementById('q30').value.trim().toLowerCase();

    var encryptionkey = 
        q1 + q2 + q3 + q4 + q5 + q6 + q7 + q8 + q9 + q10 +
        q11 + q12 + q13 + q14 + q15 + q16 + q17 + q18 + q19 + q20 +
        q21 + q22 + q23 + q24 + q25 + q26 + q27 + q28 + q29 + q30;

    var data = { qsource : "QmNY5oxKAzZwf6UswT1h3WWwWqMw58S2Qtdbjz2QVPmqEY"};
    data.qlist = [];
    if (!!q1) data.qlist.push(1);
    if (!!q2) data.qlist.push(2);
    if (!!q3) data.qlist.push(3);
    if (!!q4) data.qlist.push(4);
    if (!!q5) data.qlist.push(5);
    if (!!q6) data.qlist.push(6);
    if (!!q7) data.qlist.push(7);
    if (!!q8) data.qlist.push(8);
    if (!!q9) data.qlist.push(9);
    if (!!q10) data.qlist.push(10);
    if (!!q11) data.qlist.push(11);
    if (!!q12) data.qlist.push(12);
    if (!!q13) data.qlist.push(13);
    if (!!q14) data.qlist.push(14);
    if (!!q15) data.qlist.push(15);
    if (!!q16) data.qlist.push(16);
    if (!!q17) data.qlist.push(17);
    if (!!q18) data.qlist.push(18);
    if (!!q19) data.qlist.push(19);
    if (!!q20) data.qlist.push(20);
    if (!!q21) data.qlist.push(21);
    if (!!q22) data.qlist.push(22);
    if (!!q23) data.qlist.push(23);
    if (!!q24) data.qlist.push(24);
    if (!!q25) data.qlist.push(25);
    if (!!q26) data.qlist.push(26);
    if (!!q27) data.qlist.push(27);
    if (!!q28) data.qlist.push(28);
    if (!!q29) data.qlist.push(29);
    if (!!q30) data.qlist.push(30);

    if (data.qlist.length < 7) {
        alert("Answer atleast 7 security questions.");
        return;
    }

    var encrypteddata = sjcl.encrypt(encryptionkey, privateKey);
    data.datatype = "privatekey";
    data.encrypteddata = encrypteddata;
    var b64encrypteddata = multiSigAddressStr + window.btoa(JSON.stringify(data));

    alert ("FYI: Following recovery key string encrypted blurb will be used in the Numisafe Smart Contract:\n\n"+ b64encrypteddata);
    encryptedBlurb = b64encrypteddata;

    // make sure rest of q & a block is no longer displayed
    document.getElementById('secureacctsection').style.display = 'none';

    // now actually secure the account by interacting with Numisafe Smart Contract
    bootbox.alert("Turn on the internet now. We will save the encrypted blurb on the blockchain and transfer your assets to the multisig account.", function() { console.log("calling add_to_contract"); add_to_contract();});
}

function add_to_contract()
{

    // create a 40 byte HASH160 from phone number and email padded by 0s on right
    var phoneemail = web3.fromAscii(phone + email).slice(2);
    if (phoneemail.length > 40) {
            alert("Use smaller email address and phone number");
    } 
    phoneemail = phoneemail.padEnd(40, "0");
    console.log(web3.toAscii("0x" + phoneemail));

    // encrypted blurb is padded with 0s at the end and starts with length of blurb 
    // padding is done so that whole string size is multiple of 40 
    encryptedBlurb = web3.fromAscii(encryptedBlurb.length.toString().padStart(4, "0") + encryptedBlurb).slice(2);
    if ((encryptedBlurb.length % 40) != 0) {
        encryptedBlurb = encryptedBlurb.padEnd(40*((encryptedBlurb.length/40)+1), "0");
    }
    console.log("encrypted blurb: " + encryptedBlurb);
    console.log(web3.toAscii("0x" + encryptedBlurb));

    var shard_addr = new Array();
    
    console.log(phoneemail);
    var hash160str = Crypto.util.hexToBytes(phoneemail);
    console.log(hash160str.toString());
    var bitcoinAddress = new Bitcoin.Address(hash160str);
    bitcoinAddress.version = 0x6F //mainnet would be 0x00
    console.log(bitcoinAddress.toString());
    shard_addr[0] = bitcore.Address.fromString(bitcoinAddress.toString());
    console.log(shard_addr[0].toString());
    for (i = 1; i <= (encryptedBlurb.length/40); i++)
    {
        console.log(encryptedBlurb.slice((i-1)*40, i*40));
        hash160str = Crypto.util.hexToBytes(encryptedBlurb.slice((i-1)*40, i*40));
        console.log(hash160str.toString());
        var bitcoinAddress = new Bitcoin.Address(hash160str);
        bitcoinAddress.version = 0x6F //mainnet would be 0x00
        console.log(bitcoinAddress.toString());
        shard_addr[i] = bitcore.Address.fromString(bitcoinAddress.toString());
        console.log(shard_addr[i].toString());
    }
    console.log(shard_addr.length + " sharded addresses.");
}


function pre_start_secure_account() {
    document.getElementById('btckeyblock').style.display = 'block';
    document.getElementById('securenext').style.display = 'block';
    document.getElementById('recoveracctsection').style.display = 'none';
    document.getElementById('recoveringheader').style.display = 'none';
    document.getElementById('recover').style.display = 'none';
    document.getElementById('secure').style.display = 'none';
}

function start_secure_account() {
    // make sure other stuff is not displayed
    document.getElementById('recoveracctsection').style.display = 'none';
    document.getElementById('securingheader').style.display = 'block';
    document.getElementById('recoveringheader').style.display = 'none';
    document.getElementById('recover').style.display = 'none';
    document.getElementById('secure').style.display = 'none';
    document.getElementById('securenext').style.display = 'none';

    var isChrome = !!window.chrome && !!window.chrome.webstore;
    if (!isChrome)
    {
        alert('Only supported on google chrome.');
        window.close();
        return;
    } 
   
    email = document.getElementById('email').value.trim().toLowerCase();
    phone = document.getElementById('phone').value.trim().toLowerCase();
    btckey = document.getElementById('btckey').value.trim();
    if (!email)
    {
        alert("Please enter email.");
        return;
    }
    if (!phone)
    {
        alert("Please enter phone.");
        return;
    }
    if (!btckey)
    {
        alert("Please enter your bitcoin private key.");
        return;
    }

    // make secure account stuff is displayed now 
    document.getElementById('secureacctsection').style.display = 'block';

    // start google chrome code
    if(navigator.onLine){
        alert('We need to generate your recovery keys.\n\nTURN OFF YOUR INTERNET CONNECTION (turn off wifi or disconnect LAN).');
    } 
    document.getElementById('start').style.display = 'block';
    document.getElementById('start').addEventListener('click', start);
}

function start() {
    document.getElementById('start').style.display = 'none';
    document.getElementById('keygen').style.display = 'block';

    if(navigator.onLine){
        alert('Internet is still on. You will be at risk.');
    }
    
    // trying bitcore libraries
	originalKey = new bitcore.PrivateKey.fromString(btckey)
    originalPublicKey = new bitcore.PublicKey(originalKey)
	originalAddress = originalKey.toAddress()
	recoveryPrivateKey = new bitcore.PrivateKey()
	recoveryPublicKey = new bitcore.PublicKey(recoveryPrivateKey)
	keyAddress = recoveryPrivateKey.toAddress()
    privateKey = recoveryPrivateKey.toWIF()
    vetoPublicKey = new bitcore.PublicKey(vetoPublicKeyStr)
	console.log("btc addr = " + originalAddress)
	console.log("recovery addr = " + keyAddress)
	console.log("recovery key = " + privateKey)
	
    var pubkeys = [originalPublicKey, recoveryPublicKey, vetoPublicKey]

	multiSigAddress = new bitcore.Address(pubkeys, requiredSignatures)
    multiSigAddressStr = multiSigAddress.toString();
	console.log("multi sig address = "+ multiSigAddressStr);


    // synchronous recovery key generation
    alert ("Following recovery bitcoin address has been generated.\nYou do not need to copy this. Just FYI.\n\nPrivate Key:" + privateKey + "\n\nAddress: 0x" + keyAddress + "\n\nMultisig Address Holding Your Assets:" + multiSigAddressStr);
    document.getElementById('keygen').style.display = 'none';
    document.getElementById('questionblock').style.display = 'block';
    document.getElementById('encrypt').addEventListener('click', startEncrypt);
}

function openInNewTab(url) {
  var win = window.open(url, '_blank');
  win.focus();
}

function beginrecover()
{
    document.body.dispatchEvent(recover_account_begin_event); // start account recovery
}

function transfereth()
{
    document.body.dispatchEvent(recover_account_end_ether_event); // transfer ethereum
}

function recover() {
    // make sure other stuff is not displayed
    document.getElementById('secureacctsection').style.display = 'none';
    document.getElementById('securingheader').style.display = 'none';
    document.getElementById('recoveringheader').style.display = 'block';
    document.getElementById('recover').style.display = 'none';
    document.getElementById('secure').style.display = 'none';

    var isChrome = !!window.chrome && !!window.chrome.webstore;
    if (!isChrome)
    {
        alert('Only supported on google chrome.');
        window.close();
        return;
    } 
   
    email = document.getElementById('email').value.trim().toLowerCase();
    phone = document.getElementById('phone').value.trim().toLowerCase();
    if ((!email) && (!phone))
    {
        alert("Please enter either email or phone.");
        return;
    }

    document.body.dispatchEvent(get_original_wallet_address_by_phone_event);  // query original wallet address through phone
    document.body.dispatchEvent(get_recovery_key_info_by_phone_event);  // query recovery key info through phone
    setTimeout( 
        // wait for sometime to get the info
        function() {
        
            if (!keyAddress) {
                alert("Couldnt find out any account with phone:" + phone);
                return;
            } else {
                alert("Found an account securing address: " + originalAddress + 
                    "\n\nRecovery Address: " + keyAddress + "\n\nEncrypted Recovery Key Blurb:\n" + encryptedBlurb);
                // open decrypt tab in new window
                openInNewTab("https://chandanlottoken.github.io/eden/decrypttest.html?blub=" + encryptedBlurb);

                // Make some buttons visible
                document.getElementById('recoveracctsection').style.display = 'block';
                document.getElementById('beginrecover').style.display = 'block';
                document.getElementById('beginrecover').addEventListener('click', beginrecover);
                document.getElementById('transfereth').addEventListener('click', transfereth);
            }
        }, 
        2000);
}

document.getElementById('secure').addEventListener('click', pre_start_secure_account);
document.getElementById('securenext').addEventListener('click', start_secure_account);
document.getElementById('recover').addEventListener('click', recover);


</script>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
</body>

</html>
